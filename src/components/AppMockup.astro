---
const slides = [
  { src: "/images/app-6.png", caption: "Full Markdown" },
  { src: "/images/app-2.png", caption: "Jupyter Notebooks" },
  { src: "/images/app-3.png", caption: "OpenAPI Explorer" },
  { src: "/images/app-4.png", caption: "Live Log Viewer" },
  { src: "/images/app-5.png", caption: "HTML Preview" },
  { src: "/images/app-1.png", caption: "Mermaid Diagrams" },
  { src: "/images/app-7.png", caption: "Config Inspector" },
  { src: "/images/app-8.png", caption: "Swagger 2.0" },
  { src: "/images/app-9.png", caption: "JSON Graph View" },
  { src: "/images/app-10.png", caption: "SVG Preview" },
];
---

<div
  id="mockup-root"
  class="relative w-full max-w-2xl z-20"
  role="region"
  aria-label="Application screenshots"
>
  <!-- Glow ring behind the image -->
  <div class="mockup-glow" aria-hidden="true"></div>

  <!-- App screenshot container -->
  <div class="mockup-perspective">
    <div id="mockup-frame" class="mockup-frame">
      <div id="carousel-track">
        {
          slides.map((slide, i) => (
            <div class:list={["carousel-item", i === 0 ? "active" : ""]}>
              <img
                id={`slide-${i + 1}`}
                class="carousel-slide"
                src={slide.src}
                alt={`Dokos — ${slide.caption}`}
                loading={i === 0 ? "eager" : "lazy"}
                width="800"
                height="500"
                decoding={i === 0 ? "sync" : "async"}
              />
              <span class="carousel-caption">{slide.caption}</span>
            </div>
          ))
        }
      </div>
    </div>
  </div>

  <!-- Dot indicators -->
  <div id="carousel-dots">
    {
      slides.map((_, i) => (
        <button
          class:list={["dot", i === 0 ? "dot-active" : ""]}
          data-idx={i}
          aria-label={`Go to screenshot ${i + 1}`}
          aria-pressed={i === 0 ? "true" : "false"}
          type="button"
        />
      ))
    }
  </div>
</div>

<style>
  #mockup-root {
    display: flex;
    flex-direction: column;
    align-items: center;
    animation: mockup-enter 1s ease-out both;
    animation-delay: 0.3s;
  }

  /* Entry animation */
  @keyframes mockup-enter {
    from {
      opacity: 0;
      transform: translateY(40px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  /* Pulsing glow behind the app */
  .mockup-glow {
    position: absolute;
    inset: -20px;
    background: radial-gradient(
      ellipse at center,
      rgba(19, 91, 236, 0.3) 0%,
      rgba(16, 185, 129, 0.1) 40%,
      transparent 70%
    );
    border-radius: 24px;
    filter: blur(40px);
    animation: glow-pulse 4s ease-in-out infinite;
    z-index: -1;
  }

  @keyframes glow-pulse {
    0%,
    100% {
      opacity: 0.6;
      transform: scale(1);
    }
    50% {
      opacity: 1;
      transform: scale(1.05);
    }
  }

  /* 3D perspective wrapper */
  .mockup-perspective {
    perspective: 1000px;
    width: 100%;
  }

  /* App frame — clean floating card with 3D tilt */
  .mockup-frame {
    width: 100%;
    border-radius: 12px;
    overflow: hidden;
    background: #0b0f19;
    border: 1px solid rgba(255, 255, 255, 0.08);
    box-shadow:
      0 0 0 1px rgba(19, 91, 236, 0.1),
      0 4px 6px rgba(0, 0, 0, 0.3),
      0 25px 65px -12px rgba(0, 0, 0, 0.7),
      0 0 120px -20px rgba(19, 91, 236, 0.15);
    position: relative;
    transform-style: preserve-3d;
    transition:
      transform 0.15s ease-out,
      box-shadow 0.15s ease-out;
  }

  /* Carousel track */
  #carousel-track {
    position: relative;
    width: 100%;
    overflow: hidden;
    cursor: pointer;
  }

  .carousel-item {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    transition: opacity 700ms ease-in-out;
    will-change: opacity;
  }

  /* First child is relative to set the container height */
  .carousel-item:first-child {
    position: relative;
  }

  .carousel-item.active {
    opacity: 1;
  }

  /* Slide-in effect on active item */
  .carousel-item.slide-in {
    animation: slide-zoom 700ms ease-out;
  }

  .carousel-slide {
    width: 100%;
    height: 100%;
    object-fit: contain;
    display: block;
  }

  @keyframes slide-zoom {
    from {
      transform: scale(1.04);
      opacity: 0;
    }
    to {
      transform: scale(1);
      opacity: 1;
    }
  }

  /* Caption — floats above the image with its own 3D layer */
  .carousel-caption {
    position: absolute;
    bottom: 20px;
    left: 80%;
    transform: translateX(0%) translateY(130px);
    background: rgba(11, 15, 25, 0.7);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    /*border: 1px solid rgba(255, 255, 255, 0.12);
    box-shadow:
      0 8px 32px rgba(0, 0, 0, 0.5),
      0 0 0 1px rgba(19, 91, 236, 0.15),
      0 0 20px rgba(19, 91, 236, 0.08);*/
    color: #fff;
    font-family: "JetBrains Mono", monospace;
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 0.04em;
    padding: 8px 20px;
    border-radius: 3px;
    white-space: nowrap;
    pointer-events: none;
    opacity: 0;
    transition:
      opacity 1500ms ease 400ms,
      transform 500ms ease 400ms;
  }

  .carousel-item.active .carousel-caption {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }

  /* Dot indicators */
  #carousel-dots {
    display: flex;
    justify-content: center;
    gap: 6px;
    padding: 16px 0 0;
  }

  .dot {
    width: 6px;
    height: 6px;
    border-radius: 9999px;
    background: rgba(255, 255, 255, 0.2);
    border: none;
    cursor: pointer;
    padding: 0;
    transition:
      width 300ms ease,
      background 300ms ease;
  }

  .dot.dot-active {
    width: 22px;
    background: #135bec;
  }

  /* Shine sweep across frame on load */
  .mockup-frame::after {
    content: "";
    position: absolute;
    inset: 0;
    background: linear-gradient(
      105deg,
      transparent 40%,
      rgba(255, 255, 255, 0.06) 45%,
      rgba(255, 255, 255, 0.12) 50%,
      rgba(255, 255, 255, 0.06) 55%,
      transparent 60%
    );
    z-index: 10;
    pointer-events: none;
    animation: shine-sweep 3s ease-in-out 1.5s 1 both;
  }

  @keyframes shine-sweep {
    from {
      transform: translateX(-100%);
    }
    to {
      transform: translateX(100%);
    }
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .carousel-item,
    .carousel-item.slide-in {
      transition: none;
      animation: none;
    }
    .carousel-caption {
      transition: none;
    }
    #mockup-root {
      animation: none;
      opacity: 1;
    }
    .mockup-frame {
      animation: none;
      transition: none;
    }
    .mockup-glow {
      animation: none;
      opacity: 0.6;
    }
    .mockup-frame::after {
      animation: none;
      display: none;
    }
  }
</style>

<script>
  const TOTAL = 10;
  const INTERVAL_MS = 4000;

  const root = document.getElementById("mockup-root");
  const track = document.getElementById("carousel-track");
  const dotsContainer = document.getElementById("carousel-dots");
  const items = track?.querySelectorAll(".carousel-item");
  const dots = dotsContainer?.querySelectorAll(".dot");

  let current = 0;
  let timer: ReturnType<typeof setInterval> | null = null;

  function goTo(idx: number) {
    items?.[current]?.classList.remove("active", "slide-in");
    dots?.[current]?.classList.remove("dot-active");
    dots?.[current]?.setAttribute("aria-pressed", "false");

    current = ((idx % TOTAL) + TOTAL) % TOTAL;

    items?.[current]?.classList.add("active", "slide-in");
    dots?.[current]?.classList.add("dot-active");
    dots?.[current]?.setAttribute("aria-pressed", "true");
  }

  function startTimer() {
    if (timer) clearInterval(timer);
    timer = setInterval(() => goTo(current + 1), INTERVAL_MS);
  }

  function stopTimer() {
    if (timer) {
      clearInterval(timer);
      timer = null;
    }
  }

  // Dot click navigation
  dots?.forEach((dot, i) => {
    dot.addEventListener("click", () => {
      stopTimer();
      goTo(i);
      startTimer();
    });
  });

  // Click on image advances to next slide
  track?.addEventListener("click", () => {
    stopTimer();
    goTo(current + 1);
    startTimer();
  });

  // Pause on hover/focus
  root?.addEventListener("mouseenter", stopTimer);
  root?.addEventListener("mouseleave", startTimer);
  root?.addEventListener("focusin", stopTimer);
  root?.addEventListener("focusout", startTimer);

  // Respect reduced motion
  const prefersReducedMotion = window.matchMedia(
    "(prefers-reduced-motion: reduce)",
  ).matches;

  if (!prefersReducedMotion) {
    startTimer();
  }

  // Preload all carousel slides after page load for smooth transitions
  window.addEventListener("load", () => {
    for (let i = 2; i <= TOTAL; i++) {
      const img = document.getElementById(`slide-${i}`) as HTMLImageElement | null;
      if (img && !img.complete) {
        const preloader = new Image();
        preloader.src = img.src;
      }
    }
  });

  // 3D tilt effect following the mouse pointer
  const frame = document.getElementById("mockup-frame");
  const MAX_TILT = 8; // degrees

  if (frame && !prefersReducedMotion) {
    // Track mouse across the entire page for a wider tilt range
    document.addEventListener("mousemove", (e: MouseEvent) => {
      const rect = frame.getBoundingClientRect();
      const centerX = rect.left + rect.width / 2;
      const centerY = rect.top + rect.height / 2;

      // Use window dimensions for a much wider detection range
      const ratioX = (e.clientX - centerX) / (window.innerWidth / 2);
      const ratioY = (e.clientY - centerY) / (window.innerHeight / 2);

      // Clamp
      const clamp = (v: number) => Math.max(-1, Math.min(1, v));
      const rx = clamp(ratioX);
      const ry = clamp(ratioY);

      // rotateY follows X axis, rotateX is inverted Y axis
      frame.style.transform = `rotateY(${rx * MAX_TILT}deg) rotateX(${-ry * MAX_TILT}deg)`;
      // Dynamic shadow shift
      frame.style.boxShadow = `
        0 0 0 1px rgba(19, 91, 236, 0.1),
        ${-rx * 10}px ${-ry * 10}px 40px rgba(0, 0, 0, 0.4),
        0 25px 65px -12px rgba(0, 0, 0, 0.7),
        ${rx * 15}px ${ry * 15}px 120px -20px rgba(19, 91, 236, 0.18)
      `;
    });
  }
</script>
