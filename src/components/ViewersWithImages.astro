---
/**
 * ViewersWithImages — Igual que Viewers pero cada card tiene una imagen miniatura.
 * Tabs por categoría con animación de entrada.
 */
import Icon from './Icon.astro';
import type { Translations } from '../i18n/utils';

interface Props {
  t: Translations;
}

const { t } = Astro.props;

const tabs = [
  {
    id: 'docs',
    label: t.viewers.catDocuments,
    icon: 'description',
    color: 'text-blue-400',
    bgColor: 'bg-blue-500/10',
    borderColor: 'border-blue-500/30',
    viewers: [
      { icon: 'edit_note', name: t.viewers.markdownName, desc: t.viewers.markdownDesc, formats: '.md, .markdown, .mdown', color: 'text-blue-400', bgColor: 'bg-blue-500/10', img: '/images/app-1.png' },
      { icon: 'picture_as_pdf', name: t.viewers.pdfName, desc: t.viewers.pdfDesc, formats: '.pdf', color: 'text-red-400', bgColor: 'bg-red-500/10', img: '/images/viewer-2.png' },
      { icon: 'menu_book', name: t.viewers.epubName, desc: t.viewers.epubDesc, formats: '.epub', color: 'text-purple-400', bgColor: 'bg-purple-500/10', img: '/images/viewer-1.png' },
      { icon: 'language', name: t.viewers.htmlName, desc: t.viewers.htmlDesc, formats: '.html, .htm', color: 'text-orange-400', bgColor: 'bg-orange-500/10', img: '/images/app-5.png' },
      { icon: 'image', name: t.viewers.imageName, desc: t.viewers.imageDesc, formats: '.png, .jpg, .gif, .webp', color: 'text-cyan-400', bgColor: 'bg-cyan-500/10', img: '/images/viewer-3.png' },
      { icon: 'draw', name: t.viewers.svgName, desc: t.viewers.svgDesc, formats: '.svg', color: 'text-indigo-400', bgColor: 'bg-indigo-500/10', img: '/images/app-10.png' },
      { icon: 'functions', name: t.viewers.texName, desc: t.viewers.texDesc, formats: '.tex', color: 'text-emerald-400', bgColor: 'bg-emerald-500/10', img: '/images/viewer-6.png' },
      { icon: 'description', name: t.viewers.rstName, desc: t.viewers.rstDesc, formats: '.rst', color: 'text-rose-400', bgColor: 'bg-rose-500/10', img: '/images/viewer-7.png' },
    ],
  },
  {
    id: 'data',
    label: t.viewers.catData,
    icon: 'database',
    color: 'text-yellow-400',
    bgColor: 'bg-yellow-500/10',
    borderColor: 'border-yellow-500/30',
    viewers: [
      { icon: 'data_object', name: t.viewers.jsonName, desc: t.viewers.jsonDesc, formats: '.json', color: 'text-yellow-400', bgColor: 'bg-yellow-500/10', img: '/images/app-9.png' },
      { icon: 'account_tree', name: t.viewers.yamlName, desc: t.viewers.yamlDesc, formats: '.yaml, .yml', color: 'text-pink-400', bgColor: 'bg-pink-500/10', img: '/images/viewer-4.png' },
      { icon: 'settings', name: t.viewers.tomlName, desc: t.viewers.tomlDesc, formats: '.toml', color: 'text-amber-400', bgColor: 'bg-amber-500/10', img: '/images/viewer-5.png' },
      { icon: 'tune', name: t.viewers.iniName, desc: t.viewers.iniDesc, formats: '.ini, .cfg, .conf', color: 'text-slate-400', bgColor: 'bg-slate-500/10', img: '/images/app-7.png' },
      { icon: 'table_chart', name: t.viewers.csvName, desc: t.viewers.csvDesc, formats: '.csv', color: 'text-green-400', bgColor: 'bg-green-500/10', img: '/images/viewer-9.png' },
      { icon: 'table_rows', name: t.viewers.tsvName, desc: t.viewers.tsvDesc, formats: '.tsv, .tab', color: 'text-teal-400', bgColor: 'bg-teal-500/10', img: '/images/viewer-10.png' },
      { icon: 'library_books', name: t.viewers.bibName, desc: t.viewers.bibDesc, formats: '.bib', color: 'text-lime-400', bgColor: 'bg-lime-500/10', img: '/images/viewer-8.png' },
    ],
  },
  {
    id: 'code',
    label: t.viewers.catCode,
    icon: 'code',
    color: 'text-green-400',
    bgColor: 'bg-green-500/10',
    borderColor: 'border-green-500/30',
    viewers: [
      { icon: 'science', name: t.viewers.notebookName, desc: t.viewers.notebookDesc, formats: '.ipynb', color: 'text-orange-500', bgColor: 'bg-orange-500/10', img: '/images/app-2.png' },
      { icon: 'api', name: t.viewers.openapiName, desc: t.viewers.openapiDesc, formats: 'OpenAPI / Swagger', color: 'text-green-500', bgColor: 'bg-green-500/10', img: '/images/app-3.png' },
      { icon: 'code', name: t.viewers.codeName, desc: t.viewers.codeDesc, formats: t.viewers.codeFormats, color: 'text-violet-400', bgColor: 'bg-violet-500/10', img: '/images/feat-2.png' },
      { icon: 'compare_arrows', name: t.viewers.diffName, desc: t.viewers.diffDesc, formats: t.viewers.diffFormats, color: 'text-blue-500', bgColor: 'bg-blue-500/10', img: '/images/feat-1.png' },
      { icon: 'terminal', name: t.viewers.logName, desc: t.viewers.logDesc, formats: '.log', color: 'text-gray-400', bgColor: 'bg-gray-500/10', img: '/images/app-4.png' },
      { icon: 'difference', name: t.viewers.patchName, desc: t.viewers.patchDesc, formats: '.patch, .diff', color: 'text-sky-400', bgColor: 'bg-sky-500/10', img: '/images/viewer-11.png' },
      { icon: 'subtitles', name: t.viewers.subtitleName, desc: t.viewers.subtitleDesc, formats: '.srt, .vtt, .ass, .ssa, .sub', color: 'text-fuchsia-400', bgColor: 'bg-fuchsia-500/10', img: '/images/viewer-14.png' },
      { icon: 'format_list_bulleted', name: t.viewers.orgName, desc: t.viewers.orgDesc, formats: '.org', color: 'text-teal-400', bgColor: 'bg-teal-500/10', img: '/images/viewer-12.png' },
      { icon: 'article', name: t.viewers.asciidocName, desc: t.viewers.asciidocDesc, formats: '.adoc, .asciidoc, .asc', color: 'text-amber-400', bgColor: 'bg-amber-500/10', img: '/images/viewer-13.png' },
    ],
  },
];
---

<section class="py-20 bg-surface-dark/30" id="viewers" aria-labelledby="viewers-img-heading">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="text-center mb-12">
      <h2 id="viewers-img-heading" class="text-3xl sm:text-4xl font-bold text-white mb-4">
        {t.viewers.heading}
      </h2>
      <p class="text-slate-400 text-lg max-w-2xl mx-auto">
        {t.viewers.subheading}
      </p>
    </div>

    <!-- Tab bar -->
    <div class="flex justify-center mb-10">
      <div
        class="inline-flex gap-1 bg-surface-dark border border-slate-800 rounded-xl p-1.5 overflow-x-auto scrollbar-hide-img"
        role="tablist"
        aria-label={t.viewers.heading}
      >
        {tabs.map((tab, index) => (
          <button
            role="tab"
            aria-selected={index === 0 ? 'true' : 'false'}
            aria-controls={`vimg-panel-${tab.id}`}
            id={`vimg-tab-${tab.id}`}
            data-vimg-tab={tab.id}
            class:list={[
              'vimg-tab flex items-center gap-2 px-4 py-2.5 rounded-lg text-sm font-medium transition-all duration-300 whitespace-nowrap',
              index === 0
                ? `${tab.bgColor} ${tab.color} ${tab.borderColor} border`
                : 'text-slate-400 hover:text-white border border-transparent',
            ]}
          >
            <Icon name={tab.icon} size="text-base" />
            {tab.label}
            <span class:list={[
              'text-[10px] px-1.5 py-0.5 rounded-full font-mono',
              index === 0 ? 'bg-white/10' : 'bg-slate-800',
            ]} data-vimg-count>
              {tab.viewers.length}
            </span>
          </button>
        ))}
      </div>
    </div>

    <!-- Tab panels -->
    {tabs.map((tab, index) => (
      <div
        role="tabpanel"
        id={`vimg-panel-${tab.id}`}
        aria-labelledby={`vimg-tab-${tab.id}`}
        data-vimg-panel={tab.id}
        class:list={[
          'vimg-panel',
          index === 0 ? 'block' : 'hidden',
        ]}
      >
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
          {tab.viewers.map((v) => (
            <div class="group bg-surface-dark border border-slate-800 rounded-xl overflow-hidden hover:border-slate-600 transition-all duration-300 flex flex-row cursor-pointer" data-vimg-open={v.img} data-vimg-title={v.name} data-vimg-desc={v.desc} data-vimg-formats={v.formats}>
              {/* Imagen miniatura con icono superpuesto */}
              <div class="relative w-40 min-h-[120px] overflow-hidden flex-shrink-0 self-stretch">
                <div class={`absolute top-0 left-0 z-10 w-10 h-10 flex items-center justify-center ${v.bgColor} rounded-br-lg`}>
                  <Icon name={v.icon} class={v.color} size="text-xl" />
                </div>
                <div class="absolute bottom-1.5 left-1.5 z-10 flex flex-wrap gap-1">
                  {v.formats.split(',').map((f: string) => (
                    <span class="text-[8px] font-mono text-slate-200 bg-black/60 backdrop-blur-sm px-1.5 py-0.5 rounded">{f.trim()}</span>
                  ))}
                </div>
                <img
                  src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"
                  data-src={v.img}
                  data-load-priority={v.img.includes('/app-') ? 'post-load' : 'on-scroll'}
                  alt={`${v.name} preview`}
                  width="400"
                  height="280"
                  class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
                />
                <div class="absolute inset-0 bg-gradient-to-r from-transparent via-transparent to-surface-dark/80" />
              </div>
              {/* Contenido */}
              <div class="p-4 flex flex-col flex-1 justify-center min-w-0">
                <h3 class="font-semibold text-white text-base">{v.name}</h3>
                <p class="text-sm text-slate-400 leading-relaxed mt-2 line-clamp-3">{v.desc}</p>
              </div>
            </div>
          ))}
        </div>
      </div>
    ))}

    <!-- Lightbox modal -->
    <div
      id="vimg-lightbox"
      class="fixed inset-0 z-50 hidden items-center justify-center p-4 cursor-pointer"
      role="dialog"
      aria-modal="true"
    >
      <div id="vimg-lightbox-bg" class="absolute inset-0 bg-black/80 backdrop-blur-sm"></div>
      <div id="vimg-lightbox-content" class="relative max-w-5xl w-full flex flex-col items-center pointer-events-none">
        <img
          id="vimg-lightbox-img"
          src=""
          alt=""
          class="max-w-full max-h-[70vh] rounded-xl shadow-2xl object-contain border border-slate-700"
        />
        <div class="mt-4 text-center">
          <p id="vimg-lightbox-title" class="text-white font-semibold text-lg"></p>
          <div id="vimg-lightbox-formats" class="flex flex-wrap justify-center gap-1.5 mt-2"></div>
          <p id="vimg-lightbox-desc" class="text-slate-400 text-sm mt-2 max-w-2xl mx-auto"></p>
        </div>
      </div>
    </div>

    <!-- Bottom counter -->
    <div class="text-center mt-12">
      <span class="inline-flex items-center gap-2 bg-primary/10 border border-primary/30 text-primary px-4 py-2 rounded-full text-sm font-medium">
        <Icon name="visibility" size="text-base" />
        {t.viewers.countBadge}
      </span>
    </div>
  </div>
</section>

<style>
  .scrollbar-hide-img {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  .scrollbar-hide-img::-webkit-scrollbar {
    display: none;
  }

  .vimg-panel {
    animation: vimgFadeIn 0.35s ease-out;
  }

  @keyframes vimgFadeIn {
    from {
      opacity: 0;
      transform: translateY(8px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  #vimg-lightbox.is-open {
    display: flex;
  }

  #vimg-lightbox.is-open #vimg-lightbox-bg {
    animation: vimgBgIn 0.3s ease-out forwards;
  }

  #vimg-lightbox.is-closing #vimg-lightbox-bg {
    animation: vimgBgOut 0.25s ease-in forwards;
  }

  #vimg-lightbox.is-open #vimg-lightbox-content {
    animation: vimgContentIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
  }

  #vimg-lightbox.is-closing #vimg-lightbox-content {
    animation: vimgContentOut 0.3s cubic-bezier(0.55, 0, 1, 0.45) forwards;
  }

  @keyframes vimgBgIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  @keyframes vimgBgOut {
    from { opacity: 1; }
    to { opacity: 0; }
  }

  @keyframes vimgContentIn {
    from {
      opacity: 0;
      transform: scale(0.3) translate(var(--vimg-origin-x, 0px), var(--vimg-origin-y, 0px));
    }
    to {
      opacity: 1;
      transform: scale(1) translate(0, 0);
    }
  }

  @keyframes vimgContentOut {
    from {
      opacity: 1;
      transform: scale(1) translate(0, 0);
    }
    to {
      opacity: 0;
      transform: scale(0.3) translate(var(--vimg-origin-x, 0px), var(--vimg-origin-y, 0px));
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const tabs = document.querySelectorAll<HTMLButtonElement>('[data-vimg-tab]');
    const panels = document.querySelectorAll<HTMLDivElement>('[data-vimg-panel]');

    if (!tabs.length || !panels.length) return;

    const tabStyles: Record<string, { bgColor: string; color: string; borderColor: string }> = {
      docs:  { bgColor: 'bg-blue-500/10',   color: 'text-blue-400',   borderColor: 'border-blue-500/30' },
      data:  { bgColor: 'bg-yellow-500/10',  color: 'text-yellow-400', borderColor: 'border-yellow-500/30' },
      code:  { bgColor: 'bg-green-500/10',   color: 'text-green-400',  borderColor: 'border-green-500/30' },
    };

    const allBg = Object.values(tabStyles).map(s => s.bgColor);
    const allColor = Object.values(tabStyles).map(s => s.color);
    const allBorder = Object.values(tabStyles).map(s => s.borderColor);

    tabs.forEach((tab) => {
      tab.addEventListener('click', () => {
        const targetId = tab.dataset.vimgTab!;
        const style = tabStyles[targetId];
        if (!style) return;

        // Reset all tabs
        tabs.forEach((t) => {
          t.setAttribute('aria-selected', 'false');
          t.classList.remove(...allBg, ...allColor, ...allBorder, 'border');
          t.classList.add('text-slate-400', 'border', 'border-transparent');
          const count = t.querySelector('[data-vimg-count]');
          if (count) {
            count.classList.remove('bg-white/10');
            count.classList.add('bg-slate-800');
          }
        });

        // Activate clicked tab
        tab.setAttribute('aria-selected', 'true');
        tab.classList.remove('text-slate-400', 'border-transparent');
        tab.classList.add(style.bgColor, style.color, style.borderColor);
        const count = tab.querySelector('[data-vimg-count]');
        if (count) {
          count.classList.remove('bg-slate-800');
          count.classList.add('bg-white/10');
        }

        // Switch panels
        panels.forEach((panel) => {
          const panelId = panel.dataset.vimgPanel;
          if (panelId === targetId) {
            panel.classList.remove('hidden');
            panel.classList.add('block');
            panel.style.animation = 'none';
            panel.offsetHeight;
            panel.style.animation = '';
          } else {
            panel.classList.add('hidden');
            panel.classList.remove('block');
          }
        });
      });
    });

    // Lightbox
    const lightbox = document.getElementById('vimg-lightbox')!;
    const lightboxContent = document.getElementById('vimg-lightbox-content')!;
    const lightboxImg = document.getElementById('vimg-lightbox-img') as HTMLImageElement;
    const lightboxTitle = document.getElementById('vimg-lightbox-title')!;
    const lightboxDesc = document.getElementById('vimg-lightbox-desc')!;
    const lightboxFormats = document.getElementById('vimg-lightbox-formats')!;

    function calcOrigin(card: HTMLElement) {
      const rect = card.getBoundingClientRect();
      const centerX = rect.left + rect.width / 2;
      const centerY = rect.top + rect.height / 2;
      const viewCenterX = window.innerWidth / 2;
      const viewCenterY = window.innerHeight / 2;
      const offsetX = centerX - viewCenterX;
      const offsetY = centerY - viewCenterY;
      return { x: offsetX, y: offsetY };
    }

    // Preload all lightbox images into browser cache
    const preloadCache = new Map<string, boolean>();
    function preloadImage(src: string) {
      if (preloadCache.has(src)) return;
      preloadCache.set(src, false);
      const img = new Image();
      img.onload = () => preloadCache.set(src, true);
      img.src = src;
    }

    function openLightbox(card: HTMLElement, src: string, title: string, desc: string, formats: string) {
      const origin = calcOrigin(card);
      lightboxContent.style.setProperty('--vimg-origin-x', `${origin.x}px`);
      lightboxContent.style.setProperty('--vimg-origin-y', `${origin.y}px`);

      // Only update src if different to avoid flicker with cached images
      if (lightboxImg.dataset.currentSrc !== src) {
        lightboxImg.dataset.currentSrc = src;

        if (preloadCache.get(src)) {
          // Already in cache — assign directly, no flash
          lightboxImg.src = src;
        } else {
          // Not cached yet — hide until loaded to avoid showing stale image
          lightboxImg.style.opacity = '0';
          lightboxImg.onload = () => {
            lightboxImg.style.opacity = '';
            lightboxImg.onload = null;
          };
          lightboxImg.src = src;
        }
      }

      lightboxImg.alt = title;
      lightboxTitle.textContent = title;
      lightboxDesc.textContent = desc;
      // Render format badges
      lightboxFormats.innerHTML = '';
      formats.split(',').forEach((f) => {
        const badge = document.createElement('span');
        badge.className = 'text-xs font-mono text-slate-300 bg-white/10 border border-slate-700 px-2.5 py-1 rounded-full';
        badge.textContent = f.trim();
        lightboxFormats.appendChild(badge);
      });
      lightbox.classList.remove('hidden', 'is-closing');
      lightbox.classList.add('is-open');
      document.body.style.overflow = 'hidden';
    }

    function closeLightbox() {
      if (!lightbox.classList.contains('is-open')) return;
      lightbox.classList.add('is-closing');
      lightboxContent.addEventListener('animationend', () => {
        lightbox.classList.remove('is-open', 'is-closing');
        lightbox.classList.add('hidden');
        document.body.style.overflow = '';
      }, { once: true });
    }

    document.querySelectorAll<HTMLElement>('[data-vimg-open]').forEach((card) => {
      const src = card.dataset.vimgOpen!;
      // Preload this image into browser cache immediately
      preloadImage(src);
      card.addEventListener('click', () => {
        const title = card.dataset.vimgTitle || '';
        const desc = card.dataset.vimgDesc || '';
        const formats = card.dataset.vimgFormats || '';
        openLightbox(card, src, title, desc, formats);
      });
    });

    // Click en cualquier parte del modal cierra
    lightbox.addEventListener('click', () => {
      closeLightbox();
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && lightbox.classList.contains('is-open')) {
        closeLightbox();
      }
    });
  });
</script>

<script>
  // Deferred image loading: post-load for app-#, on-scroll for feat-#/viewer-#
  window.addEventListener('load', () => {
    // Nivel 2: cargar app-# inmediatamente tras load
    document.querySelectorAll<HTMLImageElement>('img[data-load-priority="post-load"]').forEach(img => {
      if (img.dataset.src) {
        img.src = img.dataset.src;
        img.removeAttribute('data-load-priority');
      }
    });

    // Nivel 3: feat-#/viewer-# — cargar con IntersectionObserver + fallback por timeout
    function loadRemainingImages() {
      document.querySelectorAll<HTMLImageElement>('img[data-load-priority="on-scroll"]').forEach(img => {
        if (img.dataset.src) {
          img.src = img.dataset.src;
          img.removeAttribute('data-load-priority');
        }
      });
      observer.disconnect();
    }

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(e => {
        if (e.isIntersecting) {
          const img = e.target as HTMLImageElement;
          if (img.dataset.src) {
            img.src = img.dataset.src;
            img.removeAttribute('data-load-priority');
          }
          observer.unobserve(img);
        }
      });
    }, { rootMargin: '300px' });

    document.querySelectorAll<HTMLImageElement>('img[data-load-priority="on-scroll"]').forEach(img => {
      observer.observe(img);
    });

    // Fallback: si no hubo scroll en 500ms, precargar todo igualmente
    setTimeout(loadRemainingImages, 500);
  });
</script>
