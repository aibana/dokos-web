services:
  dokos-web:
    build: .
    container_name: dokos-web
    restart: unless-stopped

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

    labels:
      traefik.enable: "true"

      # HTTPS router
      traefik.http.routers.dokos-web.rule: "Host(`dokos.app`) || Host(`www.dokos.app`)"
      traefik.http.routers.dokos-web.entrypoints: "websecure"
      traefik.http.routers.dokos-web.tls: "true"
      traefik.http.routers.dokos-web.middlewares: "www-to-apex@docker"

      # Redirect www â†’ apex
      traefik.http.middlewares.www-to-apex.redirectregex.regex: "^https://www\\.dokos\\.app/(.*)"
      traefik.http.middlewares.www-to-apex.redirectregex.replacement: "https://dokos.app/$${1}"
      traefik.http.middlewares.www-to-apex.redirectregex.permanent: "true"

      # Service
      traefik.http.services.dokos-web.loadbalancer.server.port: "80"
      traefik.http.services.dokos-web.loadbalancer.healthcheck.path: "/health"
      traefik.http.services.dokos-web.loadbalancer.healthcheck.interval: "30s"
      traefik.http.services.dokos-web.loadbalancer.healthcheck.timeout: "5s"

    networks:
      - traefik

networks:
  traefik:
    external: true
